<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>DCN Chain API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Syne:wght@500;600;700&display=swap"
        rel="stylesheet"
    />

    <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.css" rel="stylesheet" type="text/css" />

    <script type="module">
        import {
            fetchBeforeExecute,
            saveInstanceEdit,
            closePopup,
            execute
        } from './js/execute';

        import {
            loginWithMetaMask,
            fetchVersionInfo,

            updateFeatureRequestPreview,
            addDimension,
            clearDimensions,
            sendStructuredFeature,
            getFeature,

            updateTransformationPreview,
            sendStructuredTransformation,
            getTransformation,

            updateConditionPreview,
            sendStructuredCondition,
            getCondition,

            updateParticlePreview,
            fetchParticleFeatureDimensions,
            sendStructuredParticle,
            getParticle,

            fetchAccountResources,
            nextPage,
            prevPage,

            copyTextFromElement
        } from './js/simple_form';

        fetchVersionInfo();

        document.getElementById('login').addEventListener('click', loginWithMetaMask);

        document.getElementById('btn_fetchBeforeExecute').addEventListener('click', fetchBeforeExecute);
        document.getElementById('btn_saveInstanceEdit').addEventListener('click', saveInstanceEdit);
        document.getElementById('btn_closePopup').addEventListener('click', closePopup);
        document.getElementById('btn_execute').addEventListener('click', execute);
        document.getElementById('btn_executeCopyResponse').addEventListener('click', () => copyTextFromElement('executeBody'));

        document.getElementById('in_featureName').addEventListener('input', updateFeatureRequestPreview);
        document.getElementById('btn_addDimension').addEventListener('click', addDimension);
        document.getElementById('btn_clearDimensions').addEventListener('click', clearDimensions);
        document.getElementById('btn_sendStructuredFeature').addEventListener('click', sendStructuredFeature);
        document.getElementById('btn_getFeature').addEventListener('click', getFeature);
        document.getElementById('btn_featureCopyRequest').addEventListener('click', () => copyTextFromElement('POST_featureRequestBody'));

        document.getElementById('in_transformationName').addEventListener('input', updateTransformationPreview);
        document.getElementById('POST_transformationCode').addEventListener('input', updateTransformationPreview);
        document.getElementById('btn_sendStructuredTransformation').addEventListener('click', sendStructuredTransformation);
        document.getElementById('btn_getTransformation').addEventListener('click', getTransformation);
        document.getElementById('btn_transformationCopyRequest').addEventListener('click', () => copyTextFromElement('POST_transformationRequestBody'));

        document.getElementById('in_conditionName').addEventListener('input', updateConditionPreview);
        document.getElementById('POST_conditionCode').addEventListener('input', updateConditionPreview);
        document.getElementById('btn_sendStructuredCondition').addEventListener('click', sendStructuredCondition);
        document.getElementById('btn_getCondition').addEventListener('click', getCondition);
        document.getElementById('btn_conditionCopyRequest').addEventListener('click', () => copyTextFromElement('POST_conditionRequestBody'));

        document.getElementById('in_particleName').addEventListener('input', updateParticlePreview);
        document.getElementById('in_particleFeatureName').addEventListener('input', updateParticlePreview);
        document.getElementById('btn_particleLoadFeature').addEventListener('click', fetchParticleFeatureDimensions);
        document.getElementById('particleCompositesContainer').addEventListener('input', updateParticlePreview);
        document.getElementById('in_particleConditionName').addEventListener('input', updateParticlePreview);
        document.getElementById('in_particleConditionArgs').addEventListener('input', updateParticlePreview);
        document.getElementById('btn_sendStructuredParticle').addEventListener('click', sendStructuredParticle);
        document.getElementById('btn_getParticle').addEventListener('click', getParticle);
        document.getElementById('btn_particleCopyRequest').addEventListener('click', () => copyTextFromElement('POST_particleRequestBody'));

        document.getElementById('btn_fetchAccountData').addEventListener('click', fetchAccountResources);
        document.getElementById('btn_prevAccountPage').addEventListener('click', prevPage);
        document.getElementById('btn_nextAccountPage').addEventListener('click', nextPage);

        const nav = document.getElementById('siteNav');
        const navToggle = document.getElementById('siteNavToggle');
        if (nav && navToggle) {
            navToggle.addEventListener('click', () => {
                const open = nav.classList.toggle('is-open');
                navToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
            });

            nav.querySelectorAll('.site-links a').forEach((anchor) => {
                anchor.addEventListener('click', () => {
                    nav.classList.remove('is-open');
                    navToggle.setAttribute('aria-expanded', 'false');
                });
            });

            window.addEventListener('resize', () => {
                if (window.innerWidth > 900) {
                    nav.classList.remove('is-open');
                    navToggle.setAttribute('aria-expanded', 'false');
                }
            });
        }

        const tabs = Array.from(document.querySelectorAll('.group-tab'));
        const panels = Array.from(document.querySelectorAll('.tab-panel'));

        function activateTab(tabKey) {
            tabs.forEach((tab) => {
                const active = tab.dataset.tabTarget === tabKey;
                tab.classList.toggle('is-active', active);
                tab.setAttribute('aria-selected', active ? 'true' : 'false');
                tab.setAttribute('tabindex', active ? '0' : '-1');
            });

            panels.forEach((panel) => {
                panel.classList.toggle('is-active', panel.dataset.tabPanel === tabKey);
            });
        }

        tabs.forEach((tab) => {
            tab.addEventListener('click', () => activateTab(tab.dataset.tabTarget));
        });

        const initialTab = tabs.find((tab) => tab.classList.contains('is-active'))?.dataset.tabTarget || 'execute';
        activateTab(initialTab);
    </script>

    <link rel="stylesheet" href="styles/simple_form.css">
</head>

<body>
    <header class="site-nav" id="siteNav">
        <div class="site-nav-inner">
            <a href="https://decentralised.art/" class="site-brand">Decentralised Creative Network</a>
            <button
                type="button"
                class="site-nav-toggle"
                id="siteNavToggle"
                aria-expanded="false"
                aria-label="Toggle navigation menu"
            >
                <span class="site-nav-toggle-open">‚ò∞</span>
                <span class="site-nav-toggle-close">‚úï</span>
            </button>
            <nav class="site-links" aria-label="Primary">
                <a href="https://decentralised.art/">Home</a>
                <a href="https://decentralised.art/tutorial/">Tutorial</a>
                <a href="https://decentralised.art/documentation/">API Docs</a>
                <a href="https://decentralised.art/app/" class="site-link-open-network">Network</a>
            </nav>
        </div>
    </header>

    <main class="api-shell">
        <section class="api-panel">
            <div class="api-toolbar">
                <div class="api-title-wrap">
                    <h1>Decentralised Creative Network</h1>
                    <h2>Chain API</h2>
                    <div id="versionInfo" class="version-info">Loading version info...</div>
                </div>

                <div class="login-compact">
                    <button id="login" class="compact-login-btn">MetaMask Login</button>
                    <div class="login-compact-status">
                        <span>Status</span>
                        <div id="loginStatus" class="response-body compact-status-body">Waiting...</div>
                    </div>
                </div>
            </div>

            <div class="group-tabs" role="tablist" aria-label="API Sections">
                <button type="button" id="tab-btn-execute" class="group-tab is-active" role="tab" aria-selected="true" data-tab-target="execute">Execute</button>
                <button type="button" id="tab-btn-particles" class="group-tab" role="tab" aria-selected="false" tabindex="-1" data-tab-target="particles">Particles</button>
                <button type="button" id="tab-btn-features" class="group-tab" role="tab" aria-selected="false" tabindex="-1" data-tab-target="features">Features</button>
                <button type="button" id="tab-btn-transformations" class="group-tab" role="tab" aria-selected="false" tabindex="-1" data-tab-target="transformations">Transformations</button>
                <button type="button" id="tab-btn-conditions" class="group-tab" role="tab" aria-selected="false" tabindex="-1" data-tab-target="conditions">Conditions</button>
                <button type="button" id="tab-btn-account" class="group-tab" role="tab" aria-selected="false" tabindex="-1" data-tab-target="account">Account Overview</button>
            </div>

            <div class="tab-panels">
                <section class="tab-panel is-active" data-tab-panel="execute" role="tabpanel" aria-labelledby="tab-btn-execute">
                    <div class="group-head">
                      <h2>Execute</h2>
                      <p>Run a particle</p>
                    </div>
                    <div class="tab-grid">
                        <div class="tab-column">
                            <div class="form-row">
                                <div class="form-field">
                                    <label>Particle name</label>
                                    <input id="executeName" type="text" placeholder="pitch">
                                </div>
                                <button id="btn_fetchBeforeExecute" class="action-button">Fetch dependency graph</button>
                            </div>

                            <div class="form-row">
                                <div class="form-field">
                                    <label>Sample count</label>
                                    <input id="executeN" type="number" placeholder="5">
                                </div>
                                <button id="btn_execute" class="action-button">üîí Execute</button>
                            </div>

                            <p class="tab-hint">Click any node in the dependency graph to edit running instance values.</p>

                            <label>Execute response</label>
                            <div class="response-row">
                                <div id="executeCode" class="response-code">-</div>
                                <div class="response-wrapper">
                                    <button id="btn_executeCopyResponse" class="copy-button">üìã</button>
                                    <pre id="executeBody" class="response-body">Waiting...</pre>
                                </div>
                            </div>
                        </div>

                        <div class="tab-column">
                            <label>Running instances</label>
                            <div class="request-row">
                                <pre id="executeRunningInstances" class="request-body"></pre>
                            </div>

                            <label>Dependency graph</label>
                            <div class="request-row">
                                <div id="treeContainer"></div>
                            </div>

                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab-panel="particles" role="tabpanel" aria-labelledby="tab-btn-particles">
                    <div class="group-head">
                      <h2>Particles</h2>
                      <p>Interact with existing particles or create a new particle</p>
                    </div>
                    <div class="tab-grid">
                        <div class="tab-column">
                            <label>Name</label>
                            <input type="text" id="in_particleName" placeholder="melody_particle">

                            <label>Feature name</label>
                            <input id="in_particleFeatureName" type="text" placeholder="melody">

                            <div class="form-row single-action-row">
                                <button id="btn_particleLoadFeature" type="button" class="action-button">Fetch feature dimensions</button>
                                <div id="particleFeatureInfo" class="helper-info">Fetch the feature to load composite inputs.</div>
                            </div>

                            <label>Composite names (per dimension)</label>
                            <div id="particleCompositesContainer"></div>
                            <div class="helper-text">Leave empty for scalar (empty string).</div>

                            <label>Condition name</label>
                            <input id="in_particleConditionName" type="text" placeholder="is_active">

                            <label>Condition args (comma-separated)</label>
                            <input id="in_particleConditionArgs" type="text" placeholder="1, 2">

                            <label>Address (optional)</label>
                            <input id="GET_particleAddress" type="text" placeholder="0x0...">

                            <div class="button-row">
                                <button id="btn_sendStructuredParticle" class="action-button">üîí Send</button>
                                <button id="btn_getParticle" class="action-button">Fetch</button>
                            </div>
                        </div>

                        <div class="tab-column">
                            <label>Request body</label>
                            <div class="request-row">
                                <div class="response-wrapper">
                                    <button id="btn_particleCopyRequest" class="copy-button">üìã</button>
                                    <pre id="POST_particleRequestBody" class="request-body">...</pre>
                                </div>
                            </div>

                            <label>Create response</label>
                            <div class="response-row">
                                <div id="POST_particleResponseCode" class="response-code">-</div>
                                <div id="POST_particleResponseBody" class="response-body">Waiting...</div>
                            </div>

                            <label>Fetch response</label>
                            <div class="response-row">
                                <div id="GET_particleResponseCode" class="response-code">-</div>
                                <div id="GET_particleResponseBody" class="response-body">Waiting...</div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab-panel="features" role="tabpanel" aria-labelledby="tab-btn-features">
                    <div class="group-head">
                      <h2>Features</h2>
                      <p>Interact with existing features or create a new feature</p>
                    </div>
                    <div class="tab-grid">
                        <div class="tab-column">
                            <label>Name</label>
                            <input type="text" id="in_featureName" placeholder="melody">

                            <label>Dimensions</label>
                            <div id="dimensionsContainer"></div>

                            <div class="button-row">
                                <button id="btn_addDimension">‚ûï Add dimension</button>
                                <button id="btn_clearDimensions">üóëÔ∏è Clear dimensions</button>
                            </div>

                            <label>Address (optional)</label>
                            <input id="GET_featureAddress" type="text" placeholder="0x0...">

                            <div class="button-row">
                                <button id="btn_sendStructuredFeature" class="action-button">üîí Send</button>
                                <button id="btn_getFeature" class="action-button">Fetch</button>
                            </div>
                        </div>

                        <div class="tab-column">
                            <label>Request body</label>
                            <div class="request-row">
                                <div class="response-wrapper">
                                    <button id="btn_featureCopyRequest" class="copy-button">üìã</button>
                                    <pre id="POST_featureRequestBody" class="request-body">...</pre>
                                </div>
                            </div>

                            <label>Create response</label>
                            <div class="response-row">
                                <div id="POST_featureResponseCode" class="response-code">-</div>
                                <div id="POST_featureResponseBody" class="response-body">Waiting...</div>
                            </div>

                            <label>Fetch response</label>
                            <div class="response-row">
                                <div id="GET_featureResponseCode" class="response-code">-</div>
                                <div id="GET_featureResponseBody" class="response-body">Waiting...</div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab-panel="transformations" role="tabpanel" aria-labelledby="tab-btn-transformations">
                    <div class="group-head">
                      <h2>Transformations</h2>
                      <p>Interact with existing transformations or create a new transformation</p>
                    </div>
                    <div class="tab-grid">
                        <div class="tab-column">
                            <label>Name</label>
                            <input type="text" id="in_transformationName" placeholder="add">

                            <label>Solidity code</label>
                            <div class="request-body inline-code-fragment">function run(uint32 x, uint32 [] calldata args) view external returns (uint32){</div>
                            <textarea id="POST_transformationCode" placeholder="return x + args[0];"></textarea>
                            <div class="request-body inline-code-fragment">}</div>

                            <label>Address (optional)</label>
                            <input id="GET_transformationAddress" type="text" placeholder="0x0...">

                            <div class="button-row">
                                <button id="btn_sendStructuredTransformation" class="action-button">üîí Send</button>
                                <button id="btn_getTransformation" class="action-button">Fetch</button>
                            </div>
                        </div>

                        <div class="tab-column">
                            <label>Request body</label>
                            <div class="request-row">
                                <div class="response-wrapper">
                                    <button id="btn_transformationCopyRequest" class="copy-button">üìã</button>
                                    <pre id="POST_transformationRequestBody" class="request-body">...</pre>
                                </div>
                            </div>

                            <label>Create response</label>
                            <div class="response-row">
                                <div id="POST_transformationResponseCode" class="response-code">-</div>
                                <div id="POST_transformationResponseBody" class="response-body">Waiting...</div>
                            </div>

                            <label>Fetch response</label>
                            <div class="response-row">
                                <div id="GET_transformationResponseCode" class="response-code">-</div>
                                <div id="GET_transformationResponseBody" class="response-body">Waiting...</div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab-panel="conditions" role="tabpanel" aria-labelledby="tab-btn-conditions">
                    <div class="group-head">
                      <h2>Conditions</h2>
                      <p>Interact with existing conditions or create a new condition</p>
                    </div>
                    <div class="tab-grid">
                        <div class="tab-column">
                            <label>Name</label>
                            <input type="text" id="in_conditionName" placeholder="is_active">

                            <label>Solidity code</label>
                            <div class="request-body inline-code-fragment">function check(int32 [] calldata args) view external returns (bool){</div>
                            <textarea id="POST_conditionCode" placeholder="return args[0] == 1;"></textarea>
                            <div class="request-body inline-code-fragment">}</div>

                            <label>Address (optional)</label>
                            <input id="GET_conditionAddress" type="text" placeholder="0x0...">

                            <div class="button-row">
                                <button id="btn_sendStructuredCondition" class="action-button">üîí Send</button>
                                <button id="btn_getCondition" class="action-button">Fetch</button>
                            </div>
                        </div>

                        <div class="tab-column">
                            <label>Request body</label>
                            <div class="request-row">
                                <div class="response-wrapper">
                                    <button id="btn_conditionCopyRequest" class="copy-button">üìã</button>
                                    <pre id="POST_conditionRequestBody" class="request-body">...</pre>
                                </div>
                            </div>

                            <label>Create response</label>
                            <div class="response-row">
                                <div id="POST_conditionResponseCode" class="response-code">-</div>
                                <div id="POST_conditionResponseBody" class="response-body">Waiting...</div>
                            </div>

                            <label>Fetch response</label>
                            <div class="response-row">
                                <div id="GET_conditionResponseCode" class="response-code">-</div>
                                <div id="GET_conditionResponseBody" class="response-body">Waiting...</div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="tab-panel" data-tab-panel="account" role="tabpanel" aria-labelledby="tab-btn-account">
                    <div class="group-head">
                      <h2>Account Overview</h2>
                      <p>Gather information about an account</p>
                    </div>
                    <div class="tab-grid">
                        <div class="tab-column">
                            <label>Address</label>
                            <input type="text" id="accountAddressInput" placeholder="0x...">

                            <button id="btn_fetchAccountData" class="action-button">Fetch account data</button>

                            <div class="page-controls">
                                <button id="btn_prevAccountPage">‚¨Ö Prev</button>
                                <span id="accountPageLabel">Page 1</span>
                                <button id="btn_nextAccountPage">Next ‚û°</button>
                            </div>
                        </div>

                        <div class="tab-column">
                            <div class="account-grid">
                                <div>
                                    <h3>Owned Particles</h3>
                                    <div id="accountParticlesList" class="response-body">Waiting...</div>
                                </div>
                                <div>
                                    <h3>Owned Features</h3>
                                    <div id="accountFeaturesList" class="response-body">Waiting...</div>
                                </div>
                                <div>
                                    <h3>Owned Transformations</h3>
                                    <div id="accountTransformationsList" class="response-body">Waiting...</div>
                                </div>
                                <div>
                                    <h3>Owned Conditions</h3>
                                    <div id="accountConditionsList" class="response-body">Waiting...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </section>
    </main>

    <div id="popupInstanceEditor" class="popup-instance-editor" style="display:none;">
        <h3>Edit Running Instance</h3>
        <p id="popupRunningInstanceLabel"></p>
        <label>Start Point</label>
        <input type="number" id="popupStartPoint">
        <label>Transform Shift</label>
        <input type="number" id="popupTransformShift">
        <div class="button-row">
            <button id="btn_saveInstanceEdit">Save</button>
            <button id="btn_closePopup">Cancel</button>
        </div>
    </div>
    <script>
        (function setupTabFallback() {
            const tabs = Array.from(document.querySelectorAll('.group-tab'));
            const panels = Array.from(document.querySelectorAll('.tab-panel'));
            if (!tabs.length || !panels.length) return;

            function activateTab(tabKey) {
                tabs.forEach((tab) => {
                    const active = tab.dataset.tabTarget === tabKey;
                    tab.classList.toggle('is-active', active);
                    tab.setAttribute('aria-selected', active ? 'true' : 'false');
                    tab.setAttribute('tabindex', active ? '0' : '-1');
                });

                panels.forEach((panel) => {
                    panel.classList.toggle('is-active', panel.dataset.tabPanel === tabKey);
                });
            }

            tabs.forEach((tab) => {
                tab.addEventListener('click', () => activateTab(tab.dataset.tabTarget));
            });

            const initialTab = tabs.find((tab) => tab.classList.contains('is-active'))?.dataset.tabTarget || tabs[0].dataset.tabTarget;
            activateTab(initialTab);
        })();
    </script>
</body>

</html>
